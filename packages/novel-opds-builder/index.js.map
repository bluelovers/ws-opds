{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2019/3/8.\n */\n\nimport {\n\tcreateFromJSON,\n\tcreateMoment,\n\tIFilterNovelData,\n\tINovelStatCache,\n\tINovelStatCacheHistory,\n\tNovelStatCache,\n} from '@node-novel/cache-loader'\nimport { cacheSortCallback } from '@node-novel/cache-loader/lib/util'\n\nimport NovelInfo = require('node-novel-info');\nimport { NodeNovelInfo } from 'node-novel-info/class'\n\nimport { array_unique, array_unique_overwrite } from 'array-hyper-unique'\nimport StrUtil = require('str-util');\nimport Bluebird = require('bluebird');\nimport fs = require('fs-extra');\nimport path = require('path');\nimport { slugify } from 'cjk-conv/lib/zh/table/list';\nimport hashSum = require('hash-sum');\n\nimport { OPDSV1 } from 'opds-extra';\nimport { EnumLinkRel, EnumMIME } from 'opds-extra/lib/const';\n\nimport MIMETypes = require('mime-types');\n\nfunction loadNovelStatCache(json: INovelStatCache)\n{\n\treturn createFromJSON(json, {\n\t\treadonly: true,\n\t});\n}\n\nfunction toHalfWidthLocaleLowerCase(s: string)\n{\n\treturn StrUtil.toHalfWidth(s).toLocaleLowerCase()\n}\n\nexport function _cache(novelStatJsonPath: string)\n{\n\treturn Bluebird.resolve().then(async function ()\n\t{\n\t\tlet novelStatCache = await fs.readJSON(novelStatJsonPath)\n\t\t\t.then(loadNovelStatCache);\n\n\t\tlet datamap = novelStatCache.filterNovel();\n\n\t\tlet ret = Object.entries(datamap)\n\t\t\t.reduce(function (data, [pathMain, novels])\n\t\t\t{\n\t\t\t\tdata.pathMains.push(pathMain);\n\n\t\t\t\tObject.entries(novels)\n\t\t\t\t\t.forEach(function ([novelID, novel])\n\t\t\t\t\t{\n\t\t\t\t\t\tnovel.cache = novel.cache || {};\n\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tnovel.epub_date = novel.cache.epub_date && createMoment(novel.cache.epub_date)\n\t\t\t\t\t\t\t.startOf('day')\n\t\t\t\t\t\t\t.valueOf() || 0;\n\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tconst metaInfo = new NodeNovelInfo(novel.mdconf, {\n\t\t\t\t\t\t\tthrow: false,\n\t\t\t\t\t\t\tlowCheckLevel: true,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tnovel.title = metaInfo.title(novelID);\n\n\t\t\t\t\t\tlet ks = array_unique([\n\t\t\t\t\t\t\t\tnovelID,\n\t\t\t\t\t\t\t\t...metaInfo.titles(),\n\t\t\t\t\t\t\t\t...metaInfo.series_titles(),\n\t\t\t\t\t\t\t].reduce((a, v) =>\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ta.push(toHalfWidthLocaleLowerCase(v));\n\t\t\t\t\t\t\t\ta.push(toHalfWidthLocaleLowerCase(slugify(v, true)));\n\n\t\t\t\t\t\t\t\treturn a;\n\n\t\t\t\t\t\t\t}, [] as string[]).filter(v => v))\n\t\t\t\t\t\t;\n\n\t\t\t\t\t\tks\n\t\t\t\t\t\t\t.forEach(title =>\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdata.alias[title] = data.alias[title] || [];\n\n\t\t\t\t\t\t\t\tdata.alias[title].push(novel as IFilterNovelDataPlus);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\n\t\t\t\t\t\tlet alllist = array_unique(array_unique(ks.map(title => data.alias[title])).reduce((ls, list) =>\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tls.push(...list);\n\n\t\t\t\t\t\t\treturn ls;\n\t\t\t\t\t\t}, []));\n\n\t\t\t\t\t\tks\n\t\t\t\t\t\t\t.forEach(title =>\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdata.alias[title] = alllist;\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\n\t\t\t\t\t\tdata.novels.push(novel as IFilterNovelDataPlus);\n\n\t\t\t\t\t})\n\t\t\t\t;\n\n\t\t\t\treturn data\n\t\t\t}, {\n\t\t\t\tpathMains: [] as string[],\n\t\t\t\talias: {} as {\n\t\t\t\t\t[title: string]: IFilterNovelDataPlus[]\n\t\t\t\t},\n\t\t\t\tnovels: [] as IFilterNovelDataPlus[],\n\t\t\t\tauthors: [] as string[],\n\t\t\t\tmax_chapter: 0,\n\n\t\t\t\tdata: datamap,\n\n\t\t\t\tnovels2: {} as {\n\t\t\t\t\t[title: string]: INovels2Row\n\t\t\t\t},\n\n\t\t\t\tnovels3: {} as {\n\t\t\t\t\t[author: string]: IFilterNovelDataPlus[]\n\t\t\t\t},\n\n\t\t\t\tnovelStatCache,\n\t\t\t})\n\t\t;\n\n\t\tret.novels.forEach(function (novel, index)\n\t\t{\n\t\t\tnovel._index = index;\n\t\t});\n\n\t\tret.novels = ret.novels.sort(function (a, b)\n\t\t{\n\t\t\treturn b.epub_date - a.epub_date\n\t\t});\n\n\t\t//console.log(111, ret.novels.length);\n\t\t//console.log(222, Object.keys(ret.alias).length);\n\n\t\t{\n\t\t\tret.novels2 = array_unique(Object.values(ret.alias))\n\t\t\t\t.reduce(function (a, ls)\n\t\t\t\t{\n\t\t\t\t\tls = ls\n\t\t\t\t\t\t.filter(v => v.cache.chapter)\n\t\t\t\t\t\t.sort(function (a, b)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn b.epub_date - a.epub_date\n\t\t\t\t\t\t})\n\t\t\t\t\t;\n\n\t\t\t\t\tif (ls.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet title = ls[0].title;\n\t\t\t\t\t\tlet epub_date = ls[0].epub_date;\n\n\t\t\t\t\t\tlet titles: string[] = [];\n\t\t\t\t\t\tlet authors: string[] = [];\n\n\t\t\t\t\t\tls.forEach(function (novel, index)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\tconst metaInfo = new NodeNovelInfo(novel.mdconf, {\n\t\t\t\t\t\t\t\tthrow: false,\n\t\t\t\t\t\t\t\tlowCheckLevel: true,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif (index == 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttitle = metaInfo.title(novel.novelID);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\ttitles.push(...metaInfo.titles());\n\t\t\t\t\t\t\tauthors.push(...metaInfo.authors());\n\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tarray_unique_overwrite(titles);\n\t\t\t\t\t\tarray_unique_overwrite(authors);\n\n\t\t\t\t\t\ta.push({\n\t\t\t\t\t\t\ttitle,\n\t\t\t\t\t\t\ttitles,\n\t\t\t\t\t\t\tauthors,\n\t\t\t\t\t\t\tepub_date,\n\t\t\t\t\t\t\tlist: ls,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t//console.log(title, a[title], ls[0]);\n\n\t\t\t\t\t//process.exit();\n\n\t\t\t\t\treturn a;\n\t\t\t\t}, [] as INovels2Row[])\n\t\t\t\t.sort(function (a, b)\n\t\t\t\t{\n\t\t\t\t\treturn b.epub_date - a.epub_date\n\t\t\t\t})\n\t\t\t\t.reduce(function (a, data)\n\t\t\t\t{\n\t\t\t\t\ta[data.title] = data;\n\n\t\t\t\t\treturn a\n\t\t\t\t}, {} as {\n\t\t\t\t\t[title: string]: INovels2Row\n\t\t\t\t})\n\t\t\t;\n\n\t\t}\n\n\t\t//console.log(333, ret.novels2, Object.keys(ret.novels2).length);\n\n\t\t//console.log(ret.alias);\n\n\t\treturn ret\n\t})\n}\n\nexport function buildOPDS(novelStatJsonPath: string, outputOPDSPath: string)\n{\n\treturn Bluebird.resolve().then(async function ()\n\t{\n\t\tlet ret = await _cache(novelStatJsonPath);\n\n\n\t\tlet feed = OPDSV1.Feed.deserialize({\n\t\t\ttitle: '@node-novel',\n\n\t\t\tauthors: [\n\t\t\t\t{\n\t\t\t\t\tname: 'node-novel',\n\t\t\t\t\turi: 'https://demonovel.netlify.com/',\n\t\t\t\t}\n\t\t\t],\n\n\t\t});\n\n\t\tlet outputUrl = ret.novelStatCache.data.meta.outputUrl;\n\n\t\toutputUrl = 'https://gitlab.com/demonovel/epub-txt/raw/master/';\n\n\t\tif (!/\\/$/.test(outputUrl))\n\t\t{\n\t\t\toutputUrl += '/';\n\t\t}\n\n\t\tfeed.books = feed.books || [];\n\n\t\tObject.entries(ret.novels2)\n\t\t\t.forEach(function ([title, data])\n\t\t\t{\n\t\t\t\tlet authors = data.authors.reduce(function (a, b)\n\t\t\t\t{\n\t\t\t\t\ta.push({\n\t\t\t\t\t\tname: b,\n\t\t\t\t\t});\n\n\t\t\t\t\treturn a;\n\t\t\t\t}, []);\n\n\t\t\t\tlet novel: IFilterNovelDataPlus;\n\n\t\t\t\tif (data.list.length == 1)\n\t\t\t\t{\n\t\t\t\t\tnovel = data.list[0];\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tnovel = data.list[0];\n\t\t\t\t}\n\n\t\t\t\tif (novel)\n\t\t\t\t{\n\t\t\t\t\tlet links = [];\n\n\t\t\t\t\tif (novel.cache.epub_basename)\n\t\t\t\t\t{\n\t\t\t\t\t\tlinks.push({\n\t\t\t\t\t\t\trel: EnumLinkRel.ACQUISITION,\n\t\t\t\t\t\t\thref: new URL([\n\t\t\t\t\t\t\t\tnovel.pathMain,\n\t\t\t\t\t\t\t\tnovel.cache.epub_basename,\n\t\t\t\t\t\t\t].join('/'), outputUrl),\n\t\t\t\t\t\t\ttype: EnumMIME.epub,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\n\t\t\t\t\tif (novel.cache.txt_basename)\n\t\t\t\t\t{\n\t\t\t\t\t\tlinks.push({\n\t\t\t\t\t\t\trel: EnumLinkRel.ACQUISITION,\n\t\t\t\t\t\t\thref: new URL([\n\t\t\t\t\t\t\t\tnovel.pathMain,\n\t\t\t\t\t\t\t\t'out',\n\t\t\t\t\t\t\t\tnovel.cache.txt_basename,\n\t\t\t\t\t\t\t].join('/'), outputUrl),\n\t\t\t\t\t\t\ttype: EnumMIME.txt,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\n\t\t\t\t\tif (links.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (novel.mdconf.novel && novel.mdconf.novel.cover)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet href = novel.mdconf.novel.cover;\n\n\t\t\t\t\t\t\tlet type = MIMETypes.lookup(href);\n\n\t\t\t\t\t\t\tif (!type || !/image/.test(type))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttype = EnumMIME.jpg;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tlinks.push({\n\t\t\t\t\t\t\t\trel: EnumLinkRel.IMAGE,\n\t\t\t\t\t\t\t\thref,\n\t\t\t\t\t\t\t\ttype,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tlinks.push({\n\t\t\t\t\t\t\t\trel: EnumLinkRel.IMAGE_THUMBNAIL,\n\t\t\t\t\t\t\t\thref,\n\t\t\t\t\t\t\t\ttype,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet et = OPDSV1.Entry.deserialize<OPDSV1.Entry>({\n\t\t\t\t\t\t\ttitle,\n\t\t\t\t\t\t\tlinks,\n\t\t\t\t\t\t\tauthors,\n\t\t\t\t\t\t\tupdated: novel.epub_date,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tfeed.books.push(et)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t;\n\n\t\tlet xml = feed.toXML();\n\t\tawait fs.outputFile(outputOPDSPath, xml);\n\n\t\treturn {\n\t\t\tret,\n\t\t\tfeed,\n\t\t\txml,\n\t\t}\n\t});\n}\n\nexport interface INovels2Row\n{\n\tepub_date?: number,\n\ttitle?: string,\n\ttitles?: string[],\n\tauthors?: string[],\n\tlist?: IFilterNovelDataPlus[],\n}\n\nexport type IFilterNovelDataPlus = IFilterNovelData & {\n\t_index: number,\n\tupdate_date: number,\n\tupdate_date2: number,\n\tepub_date: number,\n\tsegment_date: number,\n\ttitle: string,\n};\n\nexport default buildOPDS\n"]}